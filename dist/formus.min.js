!function(){var formus=angular.module("formus",[]);formus.provider("FormusConfig",["$logProvider",function($logProvider){var getDefault=function(){return{}},configs={form:function(){return{title:"",name:"",fieldset:{fields:[]},data:{},config:{readonly:!1,buttons:[],"class":"padding-top-10",submit:{"class":"btn btn-default",title:"Save",handler:function(){}}}}},fieldset:function(){return{}},checkbox:function(){return{showLabel:!1,trueValue:!0,falseValue:!1}},radio:function(){return{inline:!0}},radio:function(){return{horizontal:!1}},group:function(){return{"class":"bordered"}},file:function(){return{showLink:!0}}},set=function(name,config){"function"!=typeof config&&$logProvider.warn("Config must be callback"),configs[name]=config},getProvider=function($log){var get=function(name){return configs[name]?configs[name]():($log.info("Don't find config for input \""+name+'"'),getDefault())};return{get:get}};return{set:set,$get:["$log",getProvider]}}]),formus.provider("FormusContainer",function(){var log,helper,defaultConfig,container={};this.setContainer=function(data){container=data};var get=function(name){var form={};return"undefined"==typeof name?log.error("Don't set form configuration name "):container[name]?(form=container[name],form.name||(form.name=name),angular.isDefined(form.parent)&&(form=helper.extendDeep(get(form.parent),angular.copy(form)))):log.error('Form configuration with name "'+name+"\" don't found in configuration container"),helper.extendDeep(angular.copy(defaultConfig),angular.copy(form))},set=this.set=function(name,value){container[name]=value};this.$get=["$log","FormusConfig","FormusHelper",function($log,FormusConfig,FormusHelper){return defaultConfig=FormusConfig.get("form"),log=$log,helper=FormusHelper,{get:get,set:set}}]}),formus.directive("formusField",["$injector","$http","$compile","$log","$templateCache","FormusLinker","FormusValidator","FormusHelper",function($injector,$http,$compile,$log,$templateCache,FormusLinker,FormusValidator,FormusHelper){return{transclude:!0,restrict:"E",require:"ngModel",scope:{config:"=",parentErrors:"=errors",ngModel:"="},link:function($scope,$element,$attr,ngModelCtrl){$scope.isValid=!0,$scope.validation=function(value){if("object"==typeof $scope.config.validators){var errors=[];angular.forEach($scope.config.validators,function(args,name){var error=FormusValidator.validate(name,value,$scope.config,args);null!==error&&"string"==typeof error&&errors.push(error)}),errors.length>0?($scope.error=errors,$scope.isValid=!1):($scope.error=null,$scope.isValid=!0)}};var initErrorsWatchers=function(){$scope.$watch("parentErrors",function(newValue){angular.isDefined(newValue)&&($scope.isParent?$scope.errors=FormusHelper.getNested(newValue,$scope.config.name,$scope.errors):$scope.error=FormusHelper.getNested(newValue,$scope.config.name,$scope.error))},!0),$scope.isParent?$scope.$watch("errors",function(newValue){angular.isDefined(newValue)&&($scope.parentErrors=newValue)},!0):$scope.$watch("error",function(newValue){angular.isDefined(newValue)&&($scope.config.name?(angular.isObject($scope.parentErrors)||($scope.parentErrors={}),$scope.parentErrors[$scope.config.name]=newValue):$scope.parentErrors=newValue)},!0)};$scope.$on("Formus.validate",function(){$scope.config.hide?($scope.error=null,$scope.isValid=!0):$scope.validation($scope.model),$scope.$emit("Formus.validated",$scope.isValid)}),$scope.init=function(){$scope.isParent="undefined"!=typeof $scope.config.fields,$scope.isParent&&"undefined"==typeof $scope.config.input&&($scope.config.input="fieldset"),$scope.$watch("ngModel",function(newValue){var value;angular.isDefined(newValue)&&angular.isDefined(value=FormusHelper.getNested(newValue,$scope.config.name))&&($scope.model=value)},!0),$scope.$watch("model",function(newValue){if(angular.isDefined(ngModelCtrl.$modelValue)){var value=FormusHelper.getNested(ngModelCtrl.$modelValue,$scope.config.name);angular.isDefined(value)&&value!==newValue&&(FormusHelper.setNested(ngModelCtrl.$modelValue,$scope.config.name,newValue),ngModelCtrl.$dirty=!0),ngModelCtrl.$dirty&&$scope.validation(newValue)}},!0),initErrorsWatchers(),FormusLinker.call($scope.config.input,{$scope:$scope,$element:$element,$attr:$attr,$ngModelCtrl:ngModelCtrl}),"function"==typeof $scope.config.linker&&$injector.invoke($scope.config.linker,this,{$scope:$scope,$element:$element,$attr:$attr,$ngModelCtrl:ngModelCtrl})};var listener=$scope.$watch("config",function(){angular.isDefined($scope.config)&&($scope.init(),listener())},!0)},controller:["$scope","$element",function(){}]}}]),formus.directive("formusForm",["$q","FormusLinker","FormusTemplates",function($q,FormusLinker,FormusTemplates){return{transclude:!0,replace:!0,restrict:"E",scope:{name:"@",fieldset:"=",errors:"=?",model:"=",config:"="},templateUrl:FormusTemplates.getUrl("form"),link:function($scope,$element,$attr){FormusLinker.formLinker({$scope:$scope,$element:$element,$attr:$attr})},controller:["$scope","$element","$rootScope",function($scope,$element,$rootScope){$scope.validate=function(){var deferred=$q.defer(),fieldsAmount=$element.find("formus-field").length,validated=0,hasInvalid=!1,handler=function(event,isValid){validated++,hasInvalid=isValid?hasInvalid:!0,validated===fieldsAmount&&(hasInvalid?deferred.reject():deferred.resolve())};return $scope.$on("Formus.validated",handler),$scope.$broadcast("Formus.validate"),deferred.promise},$scope.submit=function(){$scope.validate().then(function(){"function"==typeof $scope.config.submit.handler&&$scope.config.submit.handler()},angular.noop)},$rootScope.$on("Formus.validateForm",function(event,name){name===$scope.name&&$scope.validate().then(function(){$rootScope.$emit("Formus.validatedForm",!0)},function(){$rootScope.$emit("Formus.validatedForm",!1)})})}]}}]),formus.factory("FormusHelper",function(){var extractBackendErrors=function(response){var errors={};return angular.forEach(response.data,function(error){this[error.field]=[error.message]},errors),errors},extendDeep=function extendDeep(dst){return angular.forEach(arguments,function(obj){obj!==dst&&angular.forEach(obj,function(value,key){angular.isDefined(dst[key])&&dst[key].constructor&&dst[key].constructor===Object&&"object"==typeof dst[key]&&"object"==typeof value?extendDeep(dst[key],value):dst[key]=value})}),dst},setNested=function(model,name,value){if(name){angular.isObject(model)||(model={});var keys=name.split(".");return keys.length>1?setNested(model[keys[0]],keys.splice(1,keys.length).join("."),value):(model[name]=value,value)}return model=value,value},getNested=function(model,name,defaultValue){if(defaultValue=angular.isDefined(defaultValue)?defaultValue:void 0,angular.isDefined(model)){if(name){var keys=name.split(".");return keys.length>1?getNested(model[keys[0]],keys.splice(1,keys.length).join("."),defaultValue):getNested(model[name],!1,defaultValue)}return model}return defaultValue},initModel=function(model,field){var name=field.name;if(name){var currentModel=model,keys=name.split(".");if(keys.length>1){for(var i=0;i<keys.length-1;i++){var key=keys[i];angular.isUndefined(currentModel[key])&&(currentModel[key]={}),currentModel=currentModel[key]}name=keys[keys.length-1]}angular.isUndefined(currentModel[name])&&(currentModel[name]=field.fields?{}:""),angular.isDefined(field.default)&&(currentModel[name]=field.default),field.fields&&_.each(field.fields,function(field){currentModel[name]=initModel(currentModel[name],field)})}else angular.isUndefined(model)&&(model=field.fields?{}:""),angular.isDefined(field.default)&&(model=field.default),field.fields&&_.each(field.fields,function(field){model=initModel(model,field)});return model},extractItems=function(data,valueField,titleField,groupName){var list=[];return 4===arguments.length&&angular.isDefined(groupName)&&(data=data[groupName]),_.each(data,function(item){list.push({value:item[valueField],title:item[titleField]})}),list};return{setNested:setNested,getNested:getNested,initModel:initModel,extendDeep:extendDeep,extractBackendErrors:extractBackendErrors,extractItems:extractItems}}),formus.provider("FormusLinker",function(){function getLinker(injector,log){return{call:function(type,args){injector.invoke(linkers.default,null,args),linkers.hasOwnProperty(type)?injector.invoke(linkers[type],null,args):log.info("Don't find linker for input \""+type+'"'),injector.invoke(linkers.loadTemplate,null,args)},formLinker:function(args){injector.invoke(linkers.form,null,args)}}}var loadTemplateLinker=function($scope,$element,$compile,FormusTemplates,$log){if($scope.config){$scope.setElementTemplate=function(templateData){$element.html(templateData),$compile($element.contents())($scope),"function"==typeof $scope.afterLoadTemplate&&$scope.afterLoadTemplate()};var template=$scope.config.template;if(template)$scope.setElementTemplate(template);else{var templateName=$scope.config.templateName;if(templateName&&FormusTemplates.has(templateName))FormusTemplates.get(templateName).then(function(template){$scope.setElementTemplate(template)},function(){$log.error("Template type '"+templateName+"' not supported.")});else{var templateUrl=$scope.config.templateUrl;if(templateUrl)FormusTemplates.load(templateUrl).then(function(template){$scope.setElementTemplate(template)},null);else{var input=$scope.config.input;input&&FormusTemplates.has(input)&&FormusTemplates.get(input).then(function(template){$scope.setElementTemplate(template)},function(){$log.error("Template type '"+input+"' not supported.")})}}}}},defaultLinker=function($scope,FormusConfig){var defaultConfig=FormusConfig.get($scope.config.input);_.each(defaultConfig,function(value,name){angular.isUndefined($scope.config[name])&&($scope.config[name]=value)}),$scope.config.label&&"undefined"==typeof $scope.config.showLabel&&($scope.config.showLabel=!0)},formLinker=function($scope,FormusHelper){var listener=$scope.$watch("fieldset",function(){"undefined"!=typeof $scope.fieldset&&($scope.model=FormusHelper.initModel($scope.model,$scope.fieldset),$scope.errors=$scope.errors||{},listener())})},linkers={loadTemplate:loadTemplateLinker,"default":defaultLinker,form:formLinker,wrapperLinker:loadTemplateLinker};return{setLinker:function(type,linker){linkers[type]=linker},$get:["$injector","$log",function($injector,$log){return getLinker($injector,$log)}]}}),formus.provider("FormusTemplates",function(){var q,cache,http,log,templateMap={form:"formus/form.html",wrapper:"formus/inputs/wrapper.html",radio:"formus/inputs/radio.html",checkbox:"formus/inputs/checkbox.html",checklist:"formus/inputs/checklist.html",hidden:"formus/inputs/hidden.html",select:"formus/inputs/select.html",textarea:"formus/inputs/textarea.html",textbox:"formus/inputs/textbox.html",fieldset:"formus/inputs/fieldset.html",message:"formus/inputs/message.html",label:"formus/inputs/label.html"},setTemplateUrl=function(name,templateUrl){"string"==typeof name?templateMap[name]=templateUrl:angular.forEach(name,function(templateUrl,name){setTemplateUrl(name,templateUrl)})},has=function(name){return"undefined"!=typeof templateMap[name]},getTemplateUrl=function(name){return templateMap[name]},load=function(templateUrl){var deferred=q.defer();return http.get(templateUrl,{cache:cache}).then(function(response){deferred.resolve(response.data)},function(){log.error("Problem with loading template for "+templateUrl),deferred.reject()}),deferred.promise},get=function(name){return load(getTemplateUrl(name))};return{setTemplateUrl:setTemplateUrl,$get:["$q","$http","$templateCache","$log",function($q,$http,$templateCache,$log){return q=$q,http=$http,cache=$templateCache,log=$log,{has:has,get:get,load:load,getUrl:getTemplateUrl}}]}}),formus.provider("FormusValidator",["$logProvider",function($logProvider){var validators={required:function(value,config){return value?null:config.label+" cannot be blank"}},getProvider=function($log){function get(name){return validators[name]?validators[name]:void 0}function validate(validatorName,value,config,args){return validators[validatorName]?validators[validatorName](value,config,args):($log.warn("Don't find validator with name \""+validatorName+'"'),null)}return{get:get,validate:validate}},set=function(name,callback){"function"==typeof callback?validators[name]=callback:$logProvider.warn("Validator must be function. Can't set validator with name \""+name+'"')};return{set:set,$get:getProvider}}]),formus.directive("formusWrapper",["FormusTemplates","FormusLinker","$timeout",function(FormusTemplates){return{restrict:"AE",transclude:!0,templateUrl:FormusTemplates.getUrl("wrapper"),link:{post:function($scope){$scope.input=$scope.$$childHead.$$childHead}}}}])}(),angular.module("formus").run(["$templateCache",function($templateCache){$templateCache.put("formus/form.html",'<form role=form id={{name}} class={{config.class}} style={{config.style}} ng-submit=submit()><header><div ng-if=config.showErrors></div></header><formus-field ng-model=model errors=errors config=fieldset></formus-field><footer><div ng-repeat="btn in config.buttons" class=pull-left><button class={{btn.class}} type=button ng-if=!btn.items ng-click=btn.handler()>{{btn.title}}</button><div class="btn-group margin-left-5" ng-if=btn.items><button class="{{btn.class}} dropdown-toggle" type=button data-toggle=dropdown>{{btn.title}} <span class=caret></span></button><ul class=dropdown-menu><li ng-repeat="item in btn.items"><a ng-click=item.handler()>{{item.title}}</a></li></ul></div></div><button ng-if=config.submit type=submit class={{config.submit.class}} ng-bind=config.submit.title></button></footer></form>'),$templateCache.put("formus/inputs/checkbox.html","<div class=checkbox><label><input type=checkbox ng-true-value={{config.trueValue}} ng-false-value={{config.falseValue}} ng-model=model name={{config.name}}>{{config.label}}</label></div>"),$templateCache.put("formus/inputs/fieldset.html",'<div class=row><formus-wrapper ng-repeat="field in config.fields" class={{config.wrapClass}}><formus-field ng-model=model errors=errors config=field></formus-field></formus-wrapper></div>'),$templateCache.put("formus/inputs/radio.html",'<div ng-if=!config.inline><div class=radio ng-repeat="item in config.items"><label><input ng-value=item.value name={{name}} type=radio ng-model=$parent.model>{{item.title}}</label></div></div><div ng-if=config.inline><label class="radio radio-inline" ng-repeat="item in config.items"><input ng-value=item.value name={{name}} type=radio ng-model=$parent.model>{{item.title}}</label></div>'),$templateCache.put("formus/inputs/select.html",'<select name={{config.name}} ng-model=model class=form-control style={{config.style}} id={{config.name}} ng-options="item.value as item.title for item in config.items"><option value ng-if=config.empty>{{config.empty}}</option></select>'),$templateCache.put("formus/inputs/textarea.html","<textarea ng-readonly=config.readonly class=form-control placeholder={{config.placeholder?config.placeholder:config.label}} rows={{config.rows}} ng-model=model name={{config.name}} id={{config.name}} style={{config.style}}>\n</textarea>"),$templateCache.put("formus/inputs/textbox.html","<div ng-class=\"{'input-group': config.addon}\"><div class=input-group-addon ng-if=config.addon ng-bind=config.addon></div><input ng-readonly=config.readonly ng-model=model class=form-control id={{config.name}} name={{config.name}} placeholder={{config.placeholder?config.placeholder:config.label}}></div>"),$templateCache.put("formus/inputs/wrapper.html",'<div class="form-group margin-bottom-5 col-md-12" ng-class="{\'has-error\': input.error}"><label for={{input.config.name}} ng-show=input.config.showLabel ng-bind=input.config.label></label><div ng-transclude></div><span class=help-block ng-repeat="e in input.error" ng-bind=e></span></div>')}]);